%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ??FFT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
clear              % Remove items from workspace, freeing up system memory
clc                % Clear Command Window
clf                % Clear current figure window
close all hidden   % removal draws only those lines that are not obscured
                   % by other objects in the field of view. 
format long
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ????
fun = @(t) sin(5*2*pi*t) +sin(20*2*pi*t) + randn(size(t));
fs = 300;                       % ????
n = 10000;                      % ????
t = 0:1/fs:(n-1)/fs;            % ?????????
x = fun(t);                     % ????????

fi = 15;                         % ????????
np = 8;                         % ????
nfft = 1024;                    % FFT??
nt = length(x);                 % ???????? 
fa = fi+0.5*fs/np;              % ????????  
nf = 2^nextpow2(nt);            % ???nt?????2??????FFT??
na = round(0.5*nf/np+1);        % ??????????? 

% ??
n = 0:nt-1;                     % ?????1?????
b = n*pi*(fi+fa)/fs;            % ?????????? 
y = x.*exp(-1i*b);              % ????????????

% ??????????????
b = fft(y,nf);                  % FFT??
a(1:na) = b(1:na);              % ???????????
a(nf-na+1:nf) = b(nf-na+1:nf);  % ???????????
b = ifft(a,nf);                 % IFFT??
c = b(1:np:nt);                 % ??? 
a = fft(c,nfft)*2/nfft;         % ????FFT??  
y2 = zeros(1,nfft/2);           % ????????
y2(1:nfft/4) = a(nfft-nfft/4+1:nfft); % ?????????
y2(nfft/4+1:nfft/2) = a(1:nfft/4);    % ????????? 
n = 0:(nfft/2-1);
f2 = fi + n*2*(fa-fi)/nfft;           % ????FFT????   

% ??????FFT??????  
y1 = fft(x,nfft)*2/nfft;              % FFT??
f1 = n*fs/nfft; 
ni = round(fi*nfft/fs+1);             % ?????FFT???????????
na = round(fa*nfft/fs+1);

% ??????????
subplot(2,1,1); plot(t,x);
xlabel('t(s)');ylabel('Amp');grid on;
title('????????');axis([min(t) max(t) min(x) max(x)])
% ????????????????
nn = ni:na;
subplot(212);plot(f1(nn),abs(y1(nn)),':',f2,abs(y2));
xlabel('Freq(Hz)');ylabel('Amp');legend('General','Zoomed');grid on;   
title('Same signal under different FFT method');